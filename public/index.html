<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
    <title>DOI Search</title>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/typeahead.js/dist/typeahead.bundle.min.js"></script>
    <style type='text/css'>
      .tt-suggestion {
        padding: 4px;
        border: 1px solid black;
        background-color: #eee;
        margin-top: 4px;
      }
      .tt-cursor {
        background-color: #666;
        color: white;
      }
      .tt-cursor a:link, .tt-cursor a:visited {
        color: white;
      }
    </style>
  </head>  
  <body>
    <h1 id="main-title">DOI Search</h1>
    <div id="container">
      <form action="#" method="post" accept-charset="utf-8">
        <input class="typeahead"  type="text" name="search" value="" id="citesearch" placeholder="Search citation..." size="100"/>
        <input type="submit" value="Continue &rarr;"/>
      </form>
    </div>
    <script>
      var Bhound = Bloodhound.noConflict();
			var bh = new Bhound({
        initialize: true,
        queryTokenizer: Bhound.tokenizers.whitespace,
        datumTokenizer: Bhound.tokenizers.whitespace,
        sufficient: 1,
        remote: {
          url: '/search?q=%QUERY',
          wildcard: '%QUERY',
          transform: function(response) {
          console.log(response.data);
            return Array.isArray(response.data) ? response.data : [response.data];
          }
        },
        rateLimitBy: 'throttle',
        rateLimitWait: 100
      });


      $(document).ready(function() {
        $('#citesearch').typeahead({

          hint: false,
          highlight: true,
          minLength: 15
        },
				{
					source: bh,
          limit: 5,
          display: function(value) {
            //return 'DOI: ' + value.doi + ' ' + value.article.title;
            return '';
          },
          templates: {
            suggestion: function(result) {
              value = result.attributes;
              var doilink =  'https://ezproxy.lib.umn.edu/login?qurl=' + encodeURIComponent('https://dx.doi.org/' + value.doi);
              var authors = value.article.authors.map(function(a) {
                return a.name.surname;
              });
              return '<div><a href="' + doilink + '">' + authors.join(", ") + '|' + value.article.title + '|' + value.full_title + '|' + ' Vol: ' + value.volume + ' Issue: ' + value.issue + ' Pages: ' + value.article.pagination + ' DOI: ' + value.doi + '</a></div>';
            },
          }
				}
			);
      $('#citesearch').bind('typeahead:select', function(evt, suggestion) {
        evt.preventDefault();
        window.location = "https://ezproxy.lib.umn.edu/login?qurl=" + encodeURIComponent("https://dx.doi.org/" + suggestion.doi);
      });
		});
    </script>
  </body>
</html>
